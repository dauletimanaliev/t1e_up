{% extends "base.html" %}

{% block title %}Оформление заказа - {{ tie.name_ru }}{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Главная</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}#catalog">Каталог</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('tie_detail', tie_id=tie.id) }}">{{ tie.name_ru }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Оформление заказа</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Order Form -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-shopping-cart"></i> Оформление заказа
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" id="orderForm">
                        <!-- Customer Information -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-user text-primary"></i> Информация о покупателе
                            </h5>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="recipient_name" class="form-label">
                                        Имя <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="recipient_name" name="recipient_name"
                                        required placeholder="Введите ваше имя">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="recipient_surname" class="form-label">Фамилия</label>
                                    <input type="text" class="form-control" id="recipient_surname"
                                        name="recipient_surname" placeholder="Введите вашу фамилию">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="recipient_phone" class="form-label">
                                    Телефон <span class="text-danger">*</span>
                                </label>
                                <input type="tel" class="form-control" id="recipient_phone" name="recipient_phone"
                                    required placeholder="+7 (777) 123-45-67">
                                <div class="form-text">
                                    Укажите номер телефона для связи по заказу
                                </div>
                            </div>
                        </div>

                        <!-- Delivery Information -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-truck text-primary"></i> Информация о доставке
                            </h5>

                            <div class="mb-3">
                                <label for="delivery_address" class="form-label">
                                    Адрес доставки <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="delivery_address" name="delivery_address" rows="3"
                                    required
                                    placeholder="Укажите полный адрес доставки: город, улица, дом, квартира"></textarea>
                                <div class="form-text">
                                    Укажите полный адрес для доставки заказа
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-comment text-primary"></i> Дополнительная информация
                            </h5>

                            <div class="mb-3">
                                <label for="order_notes" class="form-label">Комментарий к заказу</label>
                                <textarea class="form-control" id="order_notes" name="order_notes" rows="3"
                                    placeholder="Любые пожелания или комментарии к заказу (необязательно)"></textarea>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card shadow sticky-top" style="top: 2rem;">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-receipt"></i> Сводка заказа
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Product Info -->
                    <div class="d-flex align-items-center mb-3">
                        {% if tie.image_path and tie.image_path != '' %}
                        <img src="{{ url_for('tie_images', filename=tie.image_path.split('/')[-1]) }}"
                            class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;"
                            alt="{{ tie.name_ru }}">
                        {% else %}
                        <div class="rounded me-3 d-flex align-items-center justify-content-center bg-light"
                            style="width: 60px; height: 60px;">
                            <i class="fas fa-tie text-muted"></i>
                        </div>
                        {% endif %}
                        <div>
                            <h6 class="mb-1">{{ tie.name_ru }}</h6>
                            <small class="text-muted">{{ tie.color_ru or 'Классический' }}</small>
                        </div>
                    </div>

                    <!-- Price Breakdown -->
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Товар:</span>
                            <span>{{ "{:,.0f}".format(tie.price) }} ₸</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Доставка:</span>
                            <span class="text-success">Бесплатно</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Итого:</strong>
                            <strong class="text-primary">{{ "{:,.0f}".format(tie.price) }} ₸</strong>
                        </div>
                    </div>

                    <!-- Delivery Info -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="mb-2">
                            <i class="fas fa-shipping-fast text-primary"></i> Доставка
                        </h6>
                        <small class="text-muted">
                            • Бесплатная доставка<br>
                            • Срок доставки: 7-15 рабочих дней<br>
                            • Отслеживание заказа по SMS
                        </small>
                    </div>

                    <!-- Payment Info -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6 class="mb-2">
                            <i class="fas fa-credit-card text-primary"></i> Оплата
                        </h6>
                        <div class="d-grid">
                            <button type="button" id="kaspiButton" class="btn btn-danger btn-lg" style="pointer-events: none; opacity: 0.5;">
                                <i class="fas fa-credit-card"></i> Оплатить через Kaspi
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('orderForm');
        const phoneInput = document.getElementById('recipient_phone');
        const kaspiButton = document.getElementById('kaspiButton');
        const requiredFields = form.querySelectorAll('[required]');

        // Phone number formatting - исправлено для цифры 7
        phoneInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');

            // Не удаляем 7, если она в начале
            if (value.startsWith('7') && value.length > 1) {
                value = value.substring(1);
            }

            if (value.length > 0) {
                if (value.length <= 3) {
                    value = `+7 (${value}`;
                } else if (value.length <= 6) {
                    value = `+7 (${value.substring(0, 3)}) ${value.substring(3)}`;
                } else if (value.length <= 8) {
                    value = `+7 (${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6)}`;
                } else {
                    value = `+7 (${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6, 8)}-${value.substring(8, 10)}`;
                }
            }
            e.target.value = value;
        });

        // Функция валидации формы
        function validateForm() {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            return isValid;
        }

        // Remove validation classes on input
        form.querySelectorAll('input, textarea').forEach(field => {
            field.addEventListener('input', function () {
                this.classList.remove('is-invalid');
                checkFormCompletion(); // Проверяем заполнение при каждом изменении
            });
        });

        // Функция проверки заполнения всех обязательных полей
        function checkFormCompletion() {
            let allFieldsFilled = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    allFieldsFilled = false;
                }
            });

            if (allFieldsFilled) {
                // Все поля заполнены - активируем кнопку Kaspi
                kaspiButton.style.pointerEvents = 'auto';
                kaspiButton.style.opacity = '1';
                kaspiButton.style.cursor = 'pointer';
            } else {
                // Не все поля заполнены - деактивируем кнопку Kaspi
                kaspiButton.style.pointerEvents = 'none';
                kaspiButton.style.opacity = '0.5';
                kaspiButton.style.cursor = 'not-allowed';
            }
        }

        // Проверяем при загрузке страницы
        checkFormCompletion();

        // Обработчик кнопки Kaspi
        kaspiButton.addEventListener('click', function() {
            if (validateForm()) {
                // Создаем заказ через AJAX
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // После создания заказа переходим на оплату
                        window.open('https://pay.kaspi.kz/pay/sl65g7ez', '_blank');
                    } else {
                        alert('Ошибка при создании заказа. Попробуйте еще раз.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ошибка при создании заказа. Попробуйте еще раз.');
                });
            } else {
                alert('Пожалуйста, заполните все обязательные поля');
            }
        });
    });

</script>
{% endblock %}